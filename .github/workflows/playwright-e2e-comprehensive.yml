# yameyame Playwright MCP ì¢…í•© E2E í…ŒìŠ¤íŠ¸ íŒŒì´í”„ë¼ì¸
# Comprehensive E2E Testing Pipeline with Playwright MCP Integration

name: ğŸ­ Playwright E2E Tests - Full Suite

on:
  push:
    branches: [main, develop]
    paths: 
      - 'src/**'
      - 'worktrees/*/src/**'
      - 'tests/**'
      - 'package.json'
      - '.github/workflows/**'
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  schedule:
    - cron: '0 2 * * *'  # ë§¤ì¼ ìƒˆë²½ 2ì‹œ (KST 11ì‹œ)
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ ì„ íƒ'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - smoke
        - visual
        - performance
        - realtime
      browsers:
        description: 'ë¸Œë¼ìš°ì € ì„ íƒ'
        required: false
        default: 'chromium,firefox,webkit'
        type: string
      devices:
        description: 'ë””ë°”ì´ìŠ¤ ì„ íƒ'
        required: false
        default: 'desktop,mobile'
        type: string

env:
  NODE_VERSION: '18'
  PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/ms-playwright
  # í…ŒìŠ¤íŠ¸ í™˜ê²½ ë³€ìˆ˜
  CI: true
  E2E_BASE_URL: http://localhost:8081
  API_BASE_URL: http://localhost:3001
  SOCKET_URL: http://localhost:3002
  # ì„±ëŠ¥ ê¸°ì¤€ê°’
  PERFORMANCE_BUDGET_LCP: 2500
  PERFORMANCE_BUDGET_FID: 100
  PERFORMANCE_BUDGET_CLS: 0.1

jobs:
  setup-and-validate:
    name: ğŸ”§ ì„¤ì • ë° ìœ íš¨ì„± ê²€ì‚¬
    runs-on: ubuntu-latest
    outputs:
      test-suites: ${{ steps.determine-suites.outputs.suites }}
      browsers: ${{ steps.determine-browsers.outputs.browsers }}
      devices: ${{ steps.determine-devices.outputs.devices }}
      cache-key: ${{ steps.cache-key.outputs.key }}
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ ìºì‹œ í‚¤ ìƒì„±
        id: cache-key
        run: |
          echo "key=node-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}" >> $GITHUB_OUTPUT

      - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ ê²°ì •
        id: determine-suites
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SUITES="${{ github.event.inputs.test_suite }}"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            SUITES="smoke,visual"
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            SUITES="all"
          else
            SUITES="smoke"
          fi
          echo "suites=$SUITES" >> $GITHUB_OUTPUT
          echo "ğŸ¯ ì„ íƒëœ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸: $SUITES"

      - name: ğŸŒ ë¸Œë¼ìš°ì € ê²°ì •
        id: determine-browsers  
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            BROWSERS="${{ github.event.inputs.browsers }}"
          else
            BROWSERS="chromium,firefox,webkit"
          fi
          echo "browsers=$BROWSERS" >> $GITHUB_OUTPUT
          echo "ğŸŒ ì„ íƒëœ ë¸Œë¼ìš°ì €: $BROWSERS"

      - name: ğŸ“± ë””ë°”ì´ìŠ¤ ê²°ì •
        id: determine-devices
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            DEVICES="${{ github.event.inputs.devices }}"
          else
            DEVICES="desktop,mobile"
          fi
          echo "devices=$DEVICES" >> $GITHUB_OUTPUT
          echo "ğŸ“± ì„ íƒëœ ë””ë°”ì´ìŠ¤: $DEVICES"

  infrastructure-setup:
    name: ğŸ—ï¸ ì¸í”„ë¼ ë° ì„œë¹„ìŠ¤ êµ¬ì„±
    runs-on: ubuntu-latest
    needs: setup-and-validate
    
    services:
      mongodb:
        image: mongo:5.0
        env:
          MONGO_INITDB_ROOT_USERNAME: test
          MONGO_INITDB_ROOT_PASSWORD: test
        ports:
          - 27017:27017
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ ì¢…ì†ì„± ì„¤ì¹˜ (ë£¨íŠ¸)
        run: npm ci

      - name: ğŸ“¦ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì¢…ì†ì„± ì„¤ì¹˜
        run: |
          echo "ğŸš€ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì¢…ì†ì„± ì„¤ì¹˜ ì¤‘..."
          
          # Backend API
          if [ -d "worktrees/backend-api" ]; then
            cd worktrees/backend-api
            npm ci --production=false
            cd ../..
          fi
          
          # Realtime Socket
          if [ -d "worktrees/realtime-socket" ]; then
            cd worktrees/realtime-socket  
            npm ci --production=false
            cd ../..
          fi
          
          # Band Integration
          if [ -d "worktrees/band-integration" ]; then
            cd worktrees/band-integration
            npm ci --production=false
            cd ../..
          fi
          
          # Database Layer
          if [ -d "worktrees/database-layer" ]; then
            cd worktrees/database-layer
            npm ci --production=false
            cd ../..
          fi
          
          # Frontend UI
          if [ -d "worktrees/frontend-ui/yameyame-app" ]; then
            cd worktrees/frontend-ui/yameyame-app
            npm ci --production=false
            cd ../../..
          fi

      - name: ğŸ­ Playwright ì„¤ì¹˜
        run: |
          npx playwright install --with-deps
          npx playwright install-deps

      - name: ğŸ“‹ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        run: |
          cat > .env.test << EOF
          NODE_ENV=test
          PORT=3001
          SOCKET_PORT=3002
          BAND_PORT=3003
          DB_PORT=5000
          FRONTEND_PORT=8081
          
          # Database
          MONGODB_URI=mongodb://test:test@localhost:27017/yameyame_test
          REDIS_URL=redis://localhost:6379
          
          # Test credentials
          TEST_BAND_CLIENT_ID=test_client_id
          TEST_BAND_CLIENT_SECRET=test_client_secret
          TEST_JWT_SECRET=test_jwt_secret_key_for_e2e_tests
          
          # Feature flags
          ENABLE_SOCKET_IO=true
          ENABLE_BAND_INTEGRATION=true
          ENABLE_MONITORING=true
          EOF

      - name: ğŸš€ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì‹œì‘
        run: |
          echo "ğŸ¬ ëª¨ë“  ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."
          
          # Database Layer (í¬íŠ¸ 5000)
          if [ -d "worktrees/database-layer" ]; then
            cd worktrees/database-layer
            npm run start:test &
            echo "ğŸ“Š Database Layer ì‹œì‘ë¨ (PID: $!)"
            cd ../..
          fi
          
          # Backend API (í¬íŠ¸ 3001)  
          if [ -d "worktrees/backend-api" ]; then
            cd worktrees/backend-api
            npm run start:test &
            echo "ğŸ”§ Backend API ì‹œì‘ë¨ (PID: $!)"
            cd ../..
          fi
          
          # Realtime Socket (í¬íŠ¸ 3002)
          if [ -d "worktrees/realtime-socket" ]; then
            cd worktrees/realtime-socket
            npm run start:test &
            echo "âš¡ Realtime Socket ì‹œì‘ë¨ (PID: $!)"
            cd ../..
          fi
          
          # Band Integration (í¬íŠ¸ 3003)
          if [ -d "worktrees/band-integration" ]; then
            cd worktrees/band-integration
            npm run start:test &
            echo "ğŸ­ Band Integration ì‹œì‘ë¨ (PID: $!)"
            cd ../..
          fi
          
          # Frontend (í¬íŠ¸ 8081) - Expo Web
          if [ -d "worktrees/frontend-ui/yameyame-app" ]; then
            cd worktrees/frontend-ui/yameyame-app
            npm run web &
            echo "ğŸ“± Frontend UI ì‹œì‘ë¨ (PID: $!)"
            cd ../../..
          fi
          
          # ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ (í¬íŠ¸ 9999)
          if [ -d "monitoring" ]; then
            cd monitoring
            npm run start &
            echo "ğŸ“Š Monitoring ì‹œì‘ë¨ (PID: $!)"
            cd ..
          fi

      - name: â³ ì„œë¹„ìŠ¤ ì¤€ë¹„ ëŒ€ê¸°
        run: |
          echo "â³ ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸° ì¤‘..."
          
          # ì„œë¹„ìŠ¤ë³„ í—¬ìŠ¤ì²´í¬
          services=(
            "http://localhost:5000/health:Database"
            "http://localhost:3001/health:Backend"
            "http://localhost:3002/health:Socket" 
            "http://localhost:3003/health:Band"
            "http://localhost:8081:Frontend"
          )
          
          for service in "${services[@]}"; do
            IFS=':' read -ra ADDR <<< "$service"
            url=${ADDR[0]}
            name=${ADDR[1]}
            
            echo "ğŸ” $name ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬ ì¤‘..."
            
            timeout=120
            while [ $timeout -gt 0 ]; do
              if curl -f -s "$url" > /dev/null; then
                echo "âœ… $name ì„œë¹„ìŠ¤ ì¤€ë¹„ ì™„ë£Œ"
                break
              fi
              
              echo "â³ $name ì„œë¹„ìŠ¤ ëŒ€ê¸° ì¤‘... (ë‚¨ì€ ì‹œê°„: ${timeout}ì´ˆ)"
              sleep 5
              ((timeout-=5))
            done
            
            if [ $timeout -eq 0 ]; then
              echo "âŒ $name ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨"
              exit 1
            fi
          done
          
          echo "ğŸ‰ ëª¨ë“  ì„œë¹„ìŠ¤ ì¤€ë¹„ ì™„ë£Œ!"

      - name: ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
        run: |
          echo "ğŸ“‹ ìµœì¢… ì„œë¹„ìŠ¤ ìƒíƒœ ì ê²€:"
          
          curl -s http://localhost:5000/health | jq '.' || echo "Database Layer ì‘ë‹µ ì—†ìŒ"
          curl -s http://localhost:3001/health | jq '.' || echo "Backend API ì‘ë‹µ ì—†ìŒ"  
          curl -s http://localhost:3002/health | jq '.' || echo "Socket Server ì‘ë‹µ ì—†ìŒ"
          curl -s http://localhost:3003/health | jq '.' || echo "Band Integration ì‘ë‹µ ì—†ìŒ"
          
          # í”„ë¡œì„¸ìŠ¤ ìƒíƒœ
          echo "ğŸ” ì‹¤í–‰ ì¤‘ì¸ Node.js í”„ë¡œì„¸ìŠ¤:"
          pgrep -f node | head -10
          
          # í¬íŠ¸ ì‚¬ìš© í˜„í™©
          echo "ğŸŒ í¬íŠ¸ ì‚¬ìš© í˜„í™©:"
          netstat -tulpn | grep -E ':(3001|3002|3003|5000|8081|9999)'

      - name: ğŸ’¾ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ìºì‹œ
        uses: actions/cache/save@v3
        with:
          path: |
            node_modules
            worktrees/*/node_modules
            ~/.cache/ms-playwright
          key: ${{ needs.setup-and-validate.outputs.cache-key }}-${{ github.sha }}

  e2e-test-matrix:
    name: ğŸ§ª E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest
    needs: [setup-and-validate, infrastructure-setup]
    if: always() && needs.infrastructure-setup.result == 'success'
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]  
        test-suite: [smoke, user-flows, realtime, performance, visual, accessibility]
        device: [desktop, mobile]
        exclude:
          # ë¦¬ì†ŒìŠ¤ ì ˆì•½ì„ ìœ„í•œ ì¡°í•© ì œì™¸
          - browser: webkit
            test-suite: performance
          - browser: firefox  
            test-suite: visual
            device: mobile
          - browser: webkit
            test-suite: accessibility
            device: mobile
    
    continue-on-error: true
    timeout-minutes: 45
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ’¾ ìºì‹œ ë³µì›
        uses: actions/cache/restore@v3
        with:
          path: |
            node_modules
            worktrees/*/node_modules
            ~/.cache/ms-playwright
          key: ${{ needs.setup-and-validate.outputs.cache-key }}-${{ github.sha }}

      - name: ğŸ­ Playwright ë¸Œë¼ìš°ì € ì„¤ì¹˜
        run: npx playwright install ${{ matrix.browser }} --with-deps

      - name: ğŸ—ï¸ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •
        run: |
          # ë””ë°”ì´ìŠ¤ë³„ ì„¤ì •
          if [ "${{ matrix.device }}" = "mobile" ]; then
            export PLAYWRIGHT_VIEWPORT_WIDTH=375
            export PLAYWRIGHT_VIEWPORT_HEIGHT=667
            export DEVICE_TYPE=mobile
          else
            export PLAYWRIGHT_VIEWPORT_WIDTH=1920
            export PLAYWRIGHT_VIEWPORT_HEIGHT=1080  
            export DEVICE_TYPE=desktop
          fi
          
          # ë¸Œë¼ìš°ì €ë³„ ì„¤ì •
          export BROWSER_NAME=${{ matrix.browser }}
          
          # í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ë³„ ì„¤ì •
          case "${{ matrix.test-suite }}" in
            "smoke")
              export TEST_TIMEOUT=30000
              export TEST_RETRIES=2
              ;;
            "performance")
              export TEST_TIMEOUT=60000
              export TEST_RETRIES=1
              ;;
            "visual")
              export TEST_TIMEOUT=45000
              export TEST_RETRIES=1
              ;;
            *)
              export TEST_TIMEOUT=30000
              export TEST_RETRIES=2
              ;;
          esac
          
          echo "ğŸ“Š í…ŒìŠ¤íŠ¸ ì„¤ì •:"
          echo "ë¸Œë¼ìš°ì €: ${{ matrix.browser }}"
          echo "ë””ë°”ì´ìŠ¤: ${{ matrix.device }}"  
          echo "í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸: ${{ matrix.test-suite }}"
          echo "íƒ€ì„ì•„ì›ƒ: $TEST_TIMEOUT"

      - name: ğŸš€ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ (ê²½ëŸ‰í™”)
        run: |
          # í…ŒìŠ¤íŠ¸ ë§¤íŠ¸ë¦­ìŠ¤ìš© ê²½ëŸ‰ ì„œë¹„ìŠ¤ ì‹œì‘
          npm run start:test-services &
          
          # ê¸°ë³¸ì ì¸ í—¬ìŠ¤ì²´í¬ë§Œ ìˆ˜í–‰
          timeout 60 bash -c 'until curl -f http://localhost:8081; do sleep 2; done'

      - name: ğŸ§ª E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          case "${{ matrix.test-suite }}" in
            "smoke")
              echo "ğŸ’¨ Smoke í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
              npx playwright test tests/e2e/smoke/ --project=${{ matrix.browser }}
              ;;
            "user-flows")
              echo "ğŸ‘¤ ì‚¬ìš©ì í”Œë¡œìš° í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
              npx playwright test tests/e2e/user-journeys/ --project=${{ matrix.browser }}
              ;;
            "realtime")
              echo "âš¡ ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
              npx playwright test tests/e2e/realtime/ --project=${{ matrix.browser }}
              ;;
            "performance")
              echo "ğŸš€ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
              npx playwright test tests/e2e/performance/ --project=${{ matrix.browser }}
              ;;
            "visual")
              echo "ğŸ¨ ì‹œê°ì  íšŒê·€ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
              npx playwright test tests/e2e/visual-regression/ --project=${{ matrix.browser }}
              ;;
            "accessibility")
              echo "â™¿ ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
              npx playwright test tests/e2e/accessibility/ --project=${{ matrix.browser }}
              ;;
          esac
        env:
          BROWSER_NAME: ${{ matrix.browser }}
          DEVICE_TYPE: ${{ matrix.device }}
          TEST_SUITE: ${{ matrix.test-suite }}

      - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„ì„
        if: always()
        run: |
          # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
          if [ -f "test-results/results.json" ]; then
            echo "ğŸ“‹ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½:"
            cat test-results/results.json | jq '.stats'
          fi
          
          # ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ ëª©ë¡
          if [ -f "test-results/failures.json" ]; then
            echo "âŒ ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸:"
            cat test-results/failures.json | jq '.failures[].title'
          fi

      - name: ğŸ“ í…ŒìŠ¤íŠ¸ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.browser }}-${{ matrix.test-suite }}-${{ matrix.device }}
          path: |
            test-results/
            playwright-report/
            screenshots/
            videos/
          retention-days: 7

  performance-analysis:
    name: ğŸ“Š ì„±ëŠ¥ ë¶„ì„ ë° ë¦¬í¬íŒ…
    runs-on: ubuntu-latest
    needs: e2e-test-matrix
    if: always() && contains(needs.e2e-test-matrix.result, 'success')
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*-performance-*
          path: performance-results/

      - name: ğŸ“Š ì„±ëŠ¥ ë°ì´í„° ì§‘ê³„ ë° ë¶„ì„
        run: |
          cat > analyze-performance.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          // ì„±ëŠ¥ ë°ì´í„° ìˆ˜ì§‘
          const collectPerformanceData = () => {
            const results = [];
            const resultsDir = 'performance-results';
            
            if (!fs.existsSync(resultsDir)) {
              console.log('ì„±ëŠ¥ ê²°ê³¼ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.');
              return [];
            }
            
            const subDirs = fs.readdirSync(resultsDir);
            
            subDirs.forEach(subDir => {
              const resultsPath = path.join(resultsDir, subDir, 'test-results', 'results.json');
              
              if (fs.existsSync(resultsPath)) {
                try {
                  const data = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
                  results.push({
                    browser: subDir.split('-')[2],
                    device: subDir.split('-')[4],
                    ...data
                  });
                } catch (error) {
                  console.log(`ê²°ê³¼ íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜: ${resultsPath}`);
                }
              }
            });
            
            return results;
          };
          
          // ì„±ëŠ¥ ë¶„ì„ ë° ë¦¬í¬íŠ¸ ìƒì„±
          const generatePerformanceReport = (data) => {
            if (data.length === 0) {
              return 'ì„±ëŠ¥ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
            }
            
            // Core Web Vitals í‰ê·  ê³„ì‚°
            const avgLCP = data.reduce((sum, d) => sum + (d.webVitals?.lcp || 0), 0) / data.length;
            const avgFID = data.reduce((sum, d) => sum + (d.webVitals?.fid || 0), 0) / data.length;
            const avgCLS = data.reduce((sum, d) => sum + (d.webVitals?.cls || 0), 0) / data.length;
            
            // API ì„±ëŠ¥ í‰ê· 
            const avgApiResponse = data.reduce((sum, d) => sum + (d.apiPerformance?.avgDuration || 0), 0) / data.length;
            
            // ë¸Œë¼ìš°ì €ë³„ ì„±ëŠ¥ ë¹„êµ
            const browserPerformance = {};
            data.forEach(d => {
              if (!browserPerformance[d.browser]) {
                browserPerformance[d.browser] = { count: 0, totalScore: 0 };
              }
              browserPerformance[d.browser].count++;
              browserPerformance[d.browser].totalScore += (d.overallScore || 0);
            });
            
            Object.keys(browserPerformance).forEach(browser => {
              browserPerformance[browser].avgScore = 
                browserPerformance[browser].totalScore / browserPerformance[browser].count;
            });
            
            return {
              summary: {
                totalTests: data.length,
                avgLCP: Math.round(avgLCP),
                avgFID: Math.round(avgFID), 
                avgCLS: Math.round(avgCLS * 1000) / 1000,
                avgApiResponse: Math.round(avgApiResponse)
              },
              browserComparison: browserPerformance,
              recommendations: generateRecommendations(avgLCP, avgFID, avgCLS, avgApiResponse)
            };
          };
          
          const generateRecommendations = (lcp, fid, cls, api) => {
            const recommendations = [];
            
            if (lcp > 2500) {
              recommendations.push(`ğŸŒ LCP ê°œì„  í•„ìš” (${lcp}ms > 2500ms): ì´ë¯¸ì§€ ìµœì í™”, ì„œë²„ ì‘ë‹µ ì‹œê°„ ê°œì„ `);
            }
            if (fid > 100) {
              recommendations.push(`â° FID ê°œì„  í•„ìš” (${fid}ms > 100ms): JavaScript ì‹¤í–‰ ìµœì í™”, ë©”ì¸ ìŠ¤ë ˆë“œ ë¸”ë¡œí‚¹ ê°ì†Œ`);
            }
            if (cls > 0.1) {
              recommendations.push(`ğŸ“ CLS ê°œì„  í•„ìš” (${cls} > 0.1): ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ë°©ì§€, ì´ë¯¸ì§€/í°íŠ¸ ì‚¬ì´ì¦ˆ ëª…ì‹œ`);
            }
            if (api > 500) {
              recommendations.push(`ğŸŒ API ì‘ë‹µ ì‹œê°„ ê°œì„  í•„ìš” (${api}ms > 500ms): ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™”, ìºì‹± ì „ëµ`);
            }
            
            if (recommendations.length === 0) {
              recommendations.push('âœ… ëª¨ë“  ì„±ëŠ¥ ì§€í‘œê°€ ëª©í‘œì¹˜ë¥¼ ë§Œì¡±í•©ë‹ˆë‹¤!');
            }
            
            return recommendations;
          };
          
          // ì‹¤í–‰
          const performanceData = collectPerformanceData();
          const report = generatePerformanceReport(performanceData);
          
          console.log('ğŸ“Š ì„±ëŠ¥ ë¶„ì„ ê²°ê³¼:');
          console.log(JSON.stringify(report, null, 2));
          
          // íŒŒì¼ë¡œ ì €ì¥
          fs.writeFileSync('performance-report.json', JSON.stringify(report, null, 2));
          
          // Markdown ë¦¬í¬íŠ¸ ìƒì„±
          let markdown = '# ğŸš€ yameyame ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼\n\n';
          markdown += `## ğŸ“Š ì„±ëŠ¥ ìš”ì•½\n\n`;
          markdown += `- **ì´ í…ŒìŠ¤íŠ¸**: ${report.summary.totalTests}ê°œ\n`;
          markdown += `- **í‰ê·  LCP**: ${report.summary.avgLCP}ms\n`;
          markdown += `- **í‰ê·  FID**: ${report.summary.avgFID}ms\n`;
          markdown += `- **í‰ê·  CLS**: ${report.summary.avgCLS}\n`;
          markdown += `- **í‰ê·  API ì‘ë‹µ**: ${report.summary.avgApiResponse}ms\n\n`;
          
          markdown += `## ğŸŒ ë¸Œë¼ìš°ì €ë³„ ì„±ëŠ¥\n\n`;
          Object.entries(report.browserComparison).forEach(([browser, data]) => {
            markdown += `- **${browser}**: ${data.avgScore.toFixed(1)}ì  (${data.count}ê°œ í…ŒìŠ¤íŠ¸)\n`;
          });
          
          markdown += `\n## ğŸ’¡ ê°œì„  ê¶Œì¥ì‚¬í•­\n\n`;
          report.recommendations.forEach(rec => {
            markdown += `${rec}\n\n`;
          });
          
          fs.writeFileSync('performance-report.md', markdown);
          EOF
          
          node analyze-performance.js

      - name: ğŸ“Š ì„±ëŠ¥ íŠ¸ë Œë“œ ë¶„ì„
        run: |
          # ì´ì „ ì„±ëŠ¥ ë°ì´í„°ì™€ ë¹„êµ (GitHub API ì‚¬ìš©)
          if [ -f "performance-report.json" ]; then
            echo "ğŸ“ˆ ì„±ëŠ¥ íŠ¸ë Œë“œ ë¶„ì„ ì¤‘..."
            
            # ê°„ë‹¨í•œ ì„±ëŠ¥ íšŒê·€ ê²€ì‚¬
            LCP=$(cat performance-report.json | jq '.summary.avgLCP')
            FID=$(cat performance-report.json | jq '.summary.avgFID')
            CLS=$(cat performance-report.json | jq '.summary.avgCLS')
            
            echo "ì„±ëŠ¥ ê¸°ì¤€ì¹˜ ê²€ì¦:"
            echo "LCP: $LCP ms (ê¸°ì¤€: < $PERFORMANCE_BUDGET_LCP ms)"
            echo "FID: $FID ms (ê¸°ì¤€: < $PERFORMANCE_BUDGET_FID ms)" 
            echo "CLS: $CLS (ê¸°ì¤€: < $PERFORMANCE_BUDGET_CLS)"
            
            # ì„±ëŠ¥ ê¸°ì¤€ ì´ˆê³¼ì‹œ ê²½ê³ 
            if (( $(echo "$LCP > $PERFORMANCE_BUDGET_LCP" | bc -l) )); then
              echo "âš ï¸ LCP ì„±ëŠ¥ ê¸°ì¤€ ì´ˆê³¼!"
              echo "performance-regression=true" >> $GITHUB_ENV
            fi
            
            if (( $(echo "$FID > $PERFORMANCE_BUDGET_FID" | bc -l) )); then
              echo "âš ï¸ FID ì„±ëŠ¥ ê¸°ì¤€ ì´ˆê³¼!"
              echo "performance-regression=true" >> $GITHUB_ENV
            fi
            
            if (( $(echo "$CLS > $PERFORMANCE_BUDGET_CLS" | bc -l) )); then
              echo "âš ï¸ CLS ì„±ëŠ¥ ê¸°ì¤€ ì´ˆê³¼!"
              echo "performance-regression=true" >> $GITHUB_ENV
            fi
          fi

      - name: ğŸ“ ì„±ëŠ¥ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: performance-analysis-report
          path: |
            performance-report.json
            performance-report.md
          retention-days: 30

      - name: ğŸ“ PR ì„±ëŠ¥ ë¦¬í¬íŠ¸ ëŒ“ê¸€
        if: github.event_name == 'pull_request' && github.event.action != 'closed'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            if (fs.existsSync('performance-report.md')) {
              const report = fs.readFileSync('performance-report.md', 'utf8');
              
              // ê¸°ì¡´ ì„±ëŠ¥ ë¦¬í¬íŠ¸ ëŒ“ê¸€ ì°¾ê¸°
              const comments = await github.rest.issues.listComments({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
              });
              
              const botComment = comments.data.find(comment => 
                comment.user.type === 'Bot' && comment.body.includes('yameyame ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼')
              );
              
              const commentBody = `${report}\n\n---\n_ìë™ ìƒì„±ë¨: ${new Date().toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'})}_`;
              
              if (botComment) {
                // ê¸°ì¡´ ëŒ“ê¸€ ì—…ë°ì´íŠ¸
                await github.rest.issues.updateComment({
                  comment_id: botComment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: commentBody
                });
              } else {
                // ìƒˆ ëŒ“ê¸€ ìƒì„±
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: commentBody
                });
              }
            }

  visual-regression-check:
    name: ğŸ¨ ì‹œê°ì  íšŒê·€ ë¶„ì„
    runs-on: ubuntu-latest
    needs: e2e-test-matrix
    if: always() && contains(needs.e2e-test-matrix.result, 'success')
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“ ì‹œê°ì  í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*-visual-*
          path: visual-results/

      - name: ğŸ¨ ì‹œê°ì  íšŒê·€ ë¶„ì„
        run: |
          echo "ğŸ¨ ì‹œê°ì  íšŒê·€ ë¶„ì„ ì‹œì‘..."
          
          TOTAL_VISUAL_TESTS=0
          FAILED_VISUAL_TESTS=0
          VISUAL_DIFFS=()
          
          for result_dir in visual-results/*/; do
            if [ -d "$result_dir" ]; then
              echo "ğŸ“ ë¶„ì„ ì¤‘: $result_dir"
              
              # ì‹¤íŒ¨í•œ ì‹œê°ì  í…ŒìŠ¤íŠ¸ ì¹´ìš´íŠ¸
              if [ -d "$result_dir/test-results" ]; then
                failed_count=$(find "$result_dir/test-results" -name "*-diff.png" | wc -l)
                total_count=$(find "$result_dir/test-results" -name "*.png" | wc -l)
                
                TOTAL_VISUAL_TESTS=$((TOTAL_VISUAL_TESTS + total_count))
                FAILED_VISUAL_TESTS=$((FAILED_VISUAL_TESTS + failed_count))
                
                if [ $failed_count -gt 0 ]; then
                  VISUAL_DIFFS+=("$result_dir: $failed_count ê°œ ì°¨ì´ì  ë°œê²¬")
                fi
              fi
            fi
          done
          
          echo "ğŸ“Š ì‹œê°ì  íšŒê·€ ë¶„ì„ ê²°ê³¼:"
          echo "ì „ì²´ ì‹œê°ì  í…ŒìŠ¤íŠ¸: $TOTAL_VISUAL_TESTS"
          echo "ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸: $FAILED_VISUAL_TESTS"
          echo "ì„±ê³µë¥ : $(( (TOTAL_VISUAL_TESTS - FAILED_VISUAL_TESTS) * 100 / TOTAL_VISUAL_TESTS ))%"
          
          if [ $FAILED_VISUAL_TESTS -gt 0 ]; then
            echo "visual-regression=true" >> $GITHUB_ENV
            echo "âš ï¸ ì‹œê°ì  íšŒê·€ ê°ì§€!"
            printf '%s\n' "${VISUAL_DIFFS[@]}"
          else
            echo "âœ… ì‹œê°ì  íšŒê·€ ì—†ìŒ"
          fi

      - name: ğŸ“ ì‹œê°ì  íšŒê·€ ë¦¬í¬íŠ¸ ìƒì„±
        if: env.visual-regression == 'true'
        run: |
          cat > visual-regression-report.md << EOF
          # ğŸ¨ ì‹œê°ì  íšŒê·€ ê°ì§€ ë¦¬í¬íŠ¸
          
          ## ğŸ“Š ìš”ì•½
          - **ê°ì§€ëœ ì‹œê°ì  ë³€ê²½ì‚¬í•­**: ${FAILED_VISUAL_TESTS}ê°œ
          - **ì „ì²´ ì‹œê°ì  í…ŒìŠ¤íŠ¸**: ${TOTAL_VISUAL_TESTS}ê°œ  
          - **ì˜í–¥ë„**: $(( FAILED_VISUAL_TESTS * 100 / TOTAL_VISUAL_TESTS ))%
          
          ## ğŸ” ìƒì„¸ ë‚´ìš©
          $(printf '%s\n' "${VISUAL_DIFFS[@]}" | sed 's/^/- /')
          
          ## ğŸ’¡ ì¡°ì¹˜ ë°©ì•ˆ
          1. ì˜ë„ëœ ë””ìì¸ ë³€ê²½ì¸ì§€ í™•ì¸
          2. ì˜ë„ëœ ë³€ê²½ì´ë¼ë©´ ê¸°ì¤€ ìŠ¤í¬ë¦°ìƒ· ì—…ë°ì´íŠ¸
          3. ì˜ë„ë˜ì§€ ì•Šì€ ë³€ê²½ì´ë¼ë©´ ì›ì¸ ì¡°ì‚¬ ë° ìˆ˜ì •
          
          ## ğŸ“ ê´€ë ¨ íŒŒì¼
          ì‹œê°ì  ì°¨ì´ì  ì´ë¯¸ì§€ëŠ” GitHub Actions ì•„í‹°íŒ©íŠ¸ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          EOF

      - name: ğŸ“ ì‹œê°ì  íšŒê·€ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        if: env.visual-regression == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: visual-regression-report
          path: visual-regression-report.md
          retention-days: 30

  notification-and-reporting:
    name: ğŸ“¢ ì•Œë¦¼ ë° ìµœì¢… ë¦¬í¬íŒ…
    runs-on: ubuntu-latest
    needs: [e2e-test-matrix, performance-analysis, visual-regression-check]
    if: always()
    
    steps:
      - name: ğŸ“Š ì „ì²´ ê²°ê³¼ ì§‘ê³„
        run: |
          echo "ğŸ“‹ yameyame E2E í…ŒìŠ¤íŠ¸ ì „ì²´ ê²°ê³¼ ì§‘ê³„"
          
          # í…ŒìŠ¤íŠ¸ ë§¤íŠ¸ë¦­ìŠ¤ ê²°ê³¼ ë¶„ì„
          TOTAL_JOBS=$(echo '${{ toJSON(needs.e2e-test-matrix.result) }}' | jq -r 'length')
          SUCCESS_JOBS=$(echo '${{ toJSON(needs.e2e-test-matrix.result) }}' | jq -r 'map(select(. == "success")) | length')
          
          echo "ì „ì²´ í…ŒìŠ¤íŠ¸ ì‘ì—…: $TOTAL_JOBS"
          echo "ì„±ê³µí•œ ì‘ì—…: $SUCCESS_JOBS"
          echo "ì„±ê³µë¥ : $(( SUCCESS_JOBS * 100 / TOTAL_JOBS ))%"
          
          # ì„±ëŠ¥ íšŒê·€ í™•ì¸
          PERFORMANCE_REGRESSION="${{ env.performance-regression }}"
          VISUAL_REGRESSION="${{ env.visual-regression }}"
          
          echo "ì„±ëŠ¥ íšŒê·€: ${PERFORMANCE_REGRESSION:-false}"
          echo "ì‹œê°ì  íšŒê·€: ${VISUAL_REGRESSION:-false}"
          
          # ì „ì²´ ìƒíƒœ ê²°ì •
          if [ "$SUCCESS_JOBS" -eq "$TOTAL_JOBS" ] && [ "$PERFORMANCE_REGRESSION" != "true" ] && [ "$VISUAL_REGRESSION" != "true" ]; then
            echo "overall-status=success" >> $GITHUB_ENV
            echo "âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!"
          else
            echo "overall-status=failure" >> $GITHUB_ENV
            echo "âŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ë˜ëŠ” íšŒê·€ ê°ì§€"
          fi

      - name: ğŸ“¢ Slack ì•Œë¦¼ (ì„±ê³µ)
        if: env.overall-status == 'success' && (github.event_name == 'push' || github.event_name == 'schedule')
        uses: 8398a7/action-slack@v3
        with:
          status: success
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: |
            ğŸ‰ yameyame E2E í…ŒìŠ¤íŠ¸ ëª¨ë‘ í†µê³¼!
            
            ğŸ“Š ê²°ê³¼:
            â€¢ ì „ì²´ í…ŒìŠ¤íŠ¸ ì‘ì—…: ${{ env.total-jobs }}ê°œ
            â€¢ ì„±ê³µë¥ : 100%
            â€¢ ì„±ëŠ¥ íšŒê·€: ì—†ìŒ
            â€¢ ì‹œê°ì  íšŒê·€: ì—†ìŒ
            
            ğŸ”— ìƒì„¸ ê²°ê³¼: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ğŸ“¢ Slack ì•Œë¦¼ (ì‹¤íŒ¨)  
        if: env.overall-status == 'failure' && (github.event_name == 'push' || github.event_name == 'schedule')
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: |
            âš ï¸ yameyame E2E í…ŒìŠ¤íŠ¸ ì´ìŠˆ ë°œìƒ
            
            ğŸ“Š ê²°ê³¼:
            â€¢ ì„±ëŠ¥ íšŒê·€: ${{ env.performance-regression || 'ì—†ìŒ' }}
            â€¢ ì‹œê°ì  íšŒê·€: ${{ env.visual-regression || 'ì—†ìŒ' }}
            
            ğŸ” ì¡°ì¹˜ í•„ìš”:
            â€¢ ì‹¤íŒ¨ ë¡œê·¸ í™•ì¸
            â€¢ íšŒê·€ ì›ì¸ ë¶„ì„
            â€¢ ìˆ˜ì • í›„ ì¬í…ŒìŠ¤íŠ¸
            
            ğŸ”— ìƒì„¸ ê²°ê³¼: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ğŸ“ˆ GitHub Pages ë¦¬í¬íŠ¸ ë°°í¬
        if: always() && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports
          destination_dir: e2e-reports/${{ github.run_number }}

      - name: ğŸ·ï¸ í…ŒìŠ¤íŠ¸ ê²°ê³¼ íƒœê·¸
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          if [ "${{ env.overall-status }}" = "success" ]; then
            git tag -a "e2e-pass-$(date +%Y%m%d-%H%M%S)" -m "E2E tests passed at $(date)"
            git push origin --tags
          fi

  cleanup:
    name: ğŸ§¹ ì •ë¦¬ ì‘ì—…
    runs-on: ubuntu-latest
    needs: [e2e-test-matrix, performance-analysis, visual-regression-check, notification-and-reporting]
    if: always()
    
    steps:
      - name: ğŸ§¹ ì•„í‹°íŒ©íŠ¸ ì •ë¦¬
        run: |
          echo "ğŸ§¹ í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ì •ë¦¬ ì‘ì—… ì‹œì‘"
          
          # 7ì¼ ì´ìƒ ëœ ì•„í‹°íŒ©íŠ¸ ì •ë¦¬ (GitHub API ì‚¬ìš©)
          # ì‹¤ì œë¡œëŠ” GitHubì˜ ì•„í‹°íŒ©íŠ¸ ë³´ì¡´ ê¸°ê°„ ì„¤ì •ìœ¼ë¡œ ìë™ ê´€ë¦¬ë¨
          
          echo "âœ… ì •ë¦¬ ì‘ì—… ì™„ë£Œ"

      - name: ğŸ“Š ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ ë¦¬í¬íŠ¸
        run: |
          echo "ğŸ’¾ GitHub Actions ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰:"
          echo "ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì‹œê°„: ${{ github.event.repository.updated_at }}"
          echo "ë§¤íŠ¸ë¦­ìŠ¤ ì‘ì—… ìˆ˜: $(echo '${{ strategy.job-total }}' || echo 'N/A')"
          
          # ì›”ê°„ ì‹¤í–‰ íšŸìˆ˜ ì¶”ì  (ê°„ë‹¨í•œ ì˜ˆì‹œ)
          echo "ğŸ“… ì´ë²ˆ ë‹¬ E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰: ${{ github.run_number }}ë²ˆì§¸"